<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyKTCN</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');

    * {
      font-family: 'Prompt', sans-serif;
    }
  </style>
</head>

<body>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
    <div class="container d-flex align-items-center justify-content-center mt-5">
    <form class="row g-3" id="myForm" onsubmit="submitForm(this)">
      <h4 class="text-primary text-center">HỆ THỐNG</h4>

        <div class="col-md-4 offset-md-4">
        <label for="teleid" class="form-label">Telegram</label>
        <input type="text" class="form-control" id="teleid" name="teleid" readonly>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="fname" class="form-label">Mã đơn hàng</label>
        <input type="text" class="form-control" id="fname" name="fname" required>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="fname" class="form-label">Dài khung</label>
        <input type="number" class="form-control" id="phong" name="phong" required>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="formFile" class="form-label">Tệp đính kèm</label>
        <input id="file" multiple class="form-control" type="file" onchange="saveFile(this)" required/>
      </div>

      <div class="col-md-4 offset-md-4">
        <button type="submit" class="btn btn-primary w-100">ĐĂNG KÝ</button>
      </div>
    </form>
  </div>

  <script>
      //telegram
    const tg = window.Telegram.WebApp.initData;
    var tgdata = decodeURIComponent(tg.split('&')[1].substring(5));
    var telegram = JSON.parse(tgdata);
    document.getElementById('teleid').value = telegram.id;
    

 function saveFile(f) {
      for(i=0; i<f.files.length; i++){
      const file = f.files[i];
      const fr = new FileReader();
    fr.readAsArrayBuffer(file);
    fr.onload = (f) => {
      const url = "https://script.google.com/macros/s/AKfycbyR3GNAATDbPhNbU4NGaPJ4nOjnlaS0ZYoNEHDI8oTAp34XRNuUV_NAx1CT8dxzxpST/exec"; // Please set the URL of Web Apps.

      const qs = new URLSearchParams({
        filename: file.name,
        mimeType: file.type,
      });
      fetch(`${url}?${qs}`, {
        method: "POST",
        body: JSON.stringify([...new Int8Array(f.target.result)]),
      })
        .then((res) => res.json())
        .then(console.log)
        .catch(console.log);
        };
      }
    }

    function submitForm(obj){
        event.preventDefault()
        Swal.fire({title:"loading.."})
        Swal.showLoading()
        google.script.run.withSuccessHandler(()=>{
          Swal.fire({
            position: "center",
            icon: "success",
            title: "Dữ liệu được ghi thành công!",
            showConfirmButton: false,
            timer: 1500
          });
          //document.getElementById('myForm').reset()
        }).saveData(obj);
    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>
